import RotatingBWBackground from '../components/RotatingBWBackground';
import GlassCard from '../components/GlassCard';
import { auth, db, presenceOnline } from '../firebase';
import { signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from 'firebase/auth';
import { ref, set, serverTimestamp } from 'firebase/database';
import { useNavigate } from 'react-router-dom';
import { useState } from 'react';
export default function Login(){const nav=useNavigate();const [mode,setMode]=useState<'guest'|'register'|'login'>('guest');const [nickname,setNickname]=useState(localStorage.getItem('nickname')||'');const [gender,setGender]=useState(localStorage.getItem('gender')||'male');const [age,setAge]=useState(localStorage.getItem('age')||'');const [country,setCountry]=useState(localStorage.getItem('country')||'');const [email,setEmail]=useState(localStorage.getItem('email')||'');const [password,setPassword]=useState(localStorage.getItem('password')||'');const afterLogin=async(user:any,isGuest:boolean)=>{(window as any)._uid=user.uid;localStorage.setItem('nickname',nickname);localStorage.setItem('gender',gender);localStorage.setItem('age',age);localStorage.setItem('country',country);if(!isGuest){localStorage.setItem('email',email);localStorage.setItem('password',password);}await set(ref(db,`/profiles/${user.uid}`),{uid:user.uid,nickname,gender,age:Number(age),country,isGuest,createdAt:serverTimestamp()});presenceOnline(user.uid);nav('/home')};const doGuest=async()=>{if(!nickname||!gender||!age||!country){alert('Please fill nickname, gender, age, country.');return;}const {user}=await signInAnonymously(auth);if(nickname)await updateProfile(user,{displayName:nickname});await afterLogin(user,true)};const doRegister=async()=>{if(!nickname||!gender||!age||!country){alert('Fill profile info first.');return;}if(!email||!password){alert('Email & password required for register.');return;}const {user}=await createUserWithEmailAndPassword(auth,email,password);if(nickname)await updateProfile(user,{displayName:nickname});await afterLogin(user,false)};const doLogin=async()=>{if(!email||!password){alert('Email & password required.');return;}const {user}=await signInWithEmailAndPassword(auth,email,password);if(nickname)await updateProfile(user,{displayName:nickname});await afterLogin(user,false)};return(<main className='min-h-screen flex items-center justify-center text-white'><RotatingBWBackground/><GlassCard className='w-[560px] p-8'><h1 className='text-4xl font-extrabold text-center'>ChatSphere</h1><p className='text-white/80 text-center mt-2'>Real-time Social Chat Community</p><div className='mt-6 grid grid-cols-2 gap-3'><input value={nickname} onChange={e=>setNickname(e.target.value)} placeholder='Nickname' className='px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:border-white/40'/><select value={gender} onChange={e=>setGender(e.target.value)} className='px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20'><option value='male'>male</option><option value='female'>female</option></select><input value={age} onChange={e=>setAge(e.target.value)} placeholder='Age' className='px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20'/><input value={country} onChange={e=>setCountry(e.target.value)} placeholder='Country (e.g., USA)' className='px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20'/></div><div className='mt-4 flex gap-2'><button onClick={()=>setMode('login')} className={`flex-1 py-2 rounded-xl ${mode==='login'?'bg-indigo-500/60':'bg-white/10'}`}>Login</button><button onClick={()=>setMode('register')} className={`flex-1 py-2 rounded-xl ${mode==='register'?'bg-indigo-500/60':'bg-white/10'}`}>Register</button><button onClick={()=>setMode('guest')} className={`flex-1 py-2 rounded-xl ${mode==='guest'?'bg-indigo-500/60':'bg-white/10'}`}>Guest</button></div>{mode!=='guest'&&(<div className='mt-3 grid grid-cols-2 gap-3'><input value={email} onChange={e=>setEmail(e.target.value)} placeholder='Email' className='px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20'/><input type='password' value={password} onChange={e=>setPassword(e.target.value)} placeholder='Password' className='px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20'/></div>)}<div className='mt-4'>{mode==='login'&&<button onClick={doLogin} className='w-full py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-teal-400 to-indigo-500'>Login</button>}{mode==='register'&&<button onClick={doRegister} className='w-full py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-teal-400 to-indigo-500'>Create Account</button>}{mode==='guest'&&<button onClick={doGuest} className='w-full py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-teal-400 to-indigo-500'>Chat as Guest</button>}</div><div className='mt-4 text-center text-white/70 text-sm'><span className='link'>Terms & Privacy Policy</span> · <span className='link'>Contact Us</span> · <a className='link' href='/blog'>Blog</a></div></GlassCard></main>) }
