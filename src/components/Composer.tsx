import { useState } from 'react';
import { db } from '../firebase';
import { ref, push, serverTimestamp } from 'firebase/database';
import EmojiHover from './EmojiHover';
function isImageUrl(s:string){return /^https?:\/\/\S+\.(gif|png|jpg|jpeg|webp)$/i.test(s)}
export default function Composer({ target }:{ target:{ roomId?:string, dmPeerId?:string } }){const [text,setText]=useState('');const uid=(window as any)._uid;const nick=localStorage.getItem('nickname')||'';const sendRecord=async(payload:any)=>{if(target.roomId){await push(ref(db,`/messages/${target.roomId}`),payload)}else if(target.dmPeerId){const tid=[uid,target.dmPeerId].sort().join('__');await push(ref(db,`/dmMessages/${tid}`),payload)}};const send=async(content:string)=>{if(!content.trim())return;const payload={type:isImageUrl(content)?'IMAGE':'TEXT',content,createdAt:serverTimestamp(),authorId:uid,authorNickname:nick};await sendRecord(payload);setText('')};return(<div className='p-3 border-t border-white/10 bg-white/5'><div className='flex gap-2 items-end'><EmojiHover onPick={(e)=>send(e)}/><textarea value={text} onChange={e=>setText(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send(text)}}} placeholder='Type a message or paste an image/GIF url...' className='flex-1 min-h-[44px] max-h-[160px] px-3 py-2 rounded-xl bg-white/10 text-white outline-none'/><button onClick={()=>send(text)} className='px-4 py-2 rounded-xl font-semibold text-white bg-gradient-to-r from-teal-400 to-indigo-500'>Send</button></div></div>)}
