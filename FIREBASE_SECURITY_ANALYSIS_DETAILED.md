# Firebase å®‰å…¨è§„åˆ™è­¦å‘Š - æ·±åº¦åˆ†æä¸æ–¹æ¡ˆ

**æ—¥æœŸï¼š** 2025-11-05  
**å½“å‰çŠ¶æ€ï¼š** Firebase ä»ç„¶å‘å‡ºå®‰å…¨è­¦å‘Š  
**æ ¹æœ¬åŸå› ï¼š** å¤šä¸ªè·¯å¾„å…·æœ‰è¿‡åº¦å¼€æ”¾çš„ `.read` æƒé™

---

## ğŸ”´ é—®é¢˜åˆ†æ

### **1. å½“å‰è§„åˆ™ä¸­ä»å­˜åœ¨çš„å®‰å…¨æ¼æ´**

ç»æ·±å…¥ä»£ç å®¡è®¡ï¼Œå‘ç°ä»¥ä¸‹è·¯å¾„å­˜åœ¨ `"auth != null"` çš„å…¨å±€è¯»æƒé™ï¼ˆå…è®¸ä»»ä½•ç™»å½•ç”¨æˆ·è¯»å–ï¼‰ï¼š

| è·¯å¾„ | å½“å‰è§„åˆ™ | é—®é¢˜ | é£é™©ç­‰çº§ |
|------|--------|------|---------|
| `presence/$uid/*` | `.read: "auth != null"` | ä»»ä½•ç™»å½•ç”¨æˆ·å¯è¯»æ‰€æœ‰ç”¨æˆ·çš„åœ¨çº¿çŠ¶æ€ã€ä½ç½®ã€lastSeen æ—¶é—´æˆ³ | ğŸ”´ **é«˜** |
| `rooms/$roomId/*` | `.read: "auth != null"` | ä»»ä½•ç™»å½•ç”¨æˆ·å¯è¯»æ‰€æœ‰æˆ¿é—´è¯¦æƒ…ï¼ˆåŒ…æ‹¬ç§å¯†æˆ¿é—´å…ƒæ•°æ®ï¼‰ | ğŸ”´ **é«˜** |
| `messages/$roomId/$msgId/*` | `.read: "auth != null"` | ä»»ä½•ç™»å½•ç”¨æˆ·å¯è¯»æ‰€æœ‰æˆ¿é—´æ¶ˆæ¯ï¼ˆåŒ…æ‹¬åº”è¯¥ç§å¯†çš„å†…å®¹ï¼‰ | ğŸ”´ **ä¸¥é‡** |
| `announcements` | `.read: "auth != null"` | è™½ç„¶æ˜¯å…¬å¼€å†…å®¹ï¼Œä½†ä»è¢«è­¦å‘Šä¸ºè¿‡åº¦å¼€æ”¾ | ğŸŸ¡ **ä¸­** |
| `posts` | `.read: "auth != null"` | ä»»ä½•ç™»å½•ç”¨æˆ·å¯è¯»æ‰€æœ‰ postsï¼ˆåº”è¯¥æœ‰å¯è§æ€§æ§åˆ¶ï¼‰ | ğŸ”´ **é«˜** |

### **2. Firebase ä¸ºä»€ä¹ˆä¼šå‘è­¦å‘Š**

Firebase çš„å®‰å…¨è§„åˆ™æ£€æŸ¥å·¥å…·ä¼šè­¦å‘Šï¼š
- **å…¨å±€ `auth != null` è¯»æƒé™** - å…è®¸ä»»ä½•è®¤è¯ç”¨æˆ·è¯»æ•´ä¸ªæ•°æ®åº“
- **æ²¡æœ‰ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶** - ç¼ºå°‘åŸºäºæ•°æ®æ‰€æœ‰æƒçš„æƒé™æ£€æŸ¥
- **éšç§æ³„éœ²é£é™©** - ç”¨æˆ·å¯ä»¥æ‰«æå…¶ä»–ç”¨æˆ·çš„æ‰€æœ‰ç§å¯†æ•°æ®

---

## ğŸ“‹ ä»£ç å®¡è®¡ - å®é™…ä½¿ç”¨åœºæ™¯

### **å“ªäº›è·¯å¾„éœ€è¦å¼€æ”¾è¯»æƒé™ï¼Ÿ**

é€šè¿‡ä»£ç åˆ†æï¼Œå‘ç°ä»¥ä¸‹åœºæ™¯éœ€è¦"ä»»ä½•ç™»å½•ç”¨æˆ·"è¯»æƒé™ï¼š

#### âœ… **éœ€è¦å¼€æ”¾çš„è·¯å¾„**

1. **`presence/$uid/*`** - ç”¨äºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨
   - ä»£ç ï¼š`useOnlineUsers.ts` ä¸­ `onValue(ref(db, 'presence'), ...)`
   - ç”¨é€”ï¼šæ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆHome.tsx å·¦ä¾§æ ï¼‰
   - éœ€æ±‚ï¼š**æ‰€æœ‰ç”¨æˆ·éƒ½éœ€è¦çœ‹åˆ°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨**
   
2. **`rooms/$roomId/*`**ï¼ˆä»…å…¬å¼€æˆ¿é—´ï¼‰ - ç”¨äºæˆ¿é—´åˆ—è¡¨
   - ä»£ç ï¼š`useRooms.ts` / `Home.tsx` ä¸­ `onValue(ref(db, 'rooms'), ...)`
   - ç”¨é€”ï¼šæ˜¾ç¤ºå¯åŠ å…¥çš„æˆ¿é—´åˆ—è¡¨
   - éœ€æ±‚ï¼š**ç”¨æˆ·éœ€è¦çœ‹åˆ°å…¬å¼€æˆ¿é—´ï¼Œä½†ä¸åº”çœ‹åˆ°ç§å¯†æˆ¿é—´çš„å…ƒæ•°æ®**

3. **`messages/$roomId/$msgId/*`**ï¼ˆä»…å½“ç”¨æˆ·æ˜¯æˆå‘˜ï¼‰ - æˆ¿é—´æ¶ˆæ¯
   - ä»£ç ï¼š`Home.tsx` ä¸­åŠ è½½æˆ¿é—´æ¶ˆæ¯
   - ç”¨é€”ï¼šæ˜¾ç¤ºæˆ¿é—´å†…çš„æ¶ˆæ¯
   - éœ€æ±‚ï¼š**ç”¨æˆ·éœ€è¦è¯»è‡ªå·±åŠ å…¥çš„æˆ¿é—´æ¶ˆæ¯ï¼Œä½†ä¸åº”è¯»æœªåŠ å…¥æˆ¿é—´çš„æ¶ˆæ¯**

4. **`announcements`** - å…¬å¼€å…¬å‘Š
   - ä»£ç ï¼šAdmin Dashboard æ˜¾ç¤ºå…¬å‘Š
   - ç”¨é€”ï¼šç³»ç»Ÿçº§å…¬å‘Š
   - éœ€æ±‚ï¼š**æ‰€æœ‰ç™»å½•ç”¨æˆ·å¯è§**

#### âŒ **ä¸åº”è¯¥å¼€æ”¾çš„è·¯å¾„**

1. **`profiles/$uid/*`** - ç”¨æˆ·æ¡£æ¡ˆï¼ˆéƒ¨åˆ†å­—æ®µï¼‰
   - å½“å‰è§„åˆ™ï¼š`.read: "auth != null"` âœ… å·²æ­£ç¡®ï¼ˆä½†åº”è¯¥è¿›ä¸€æ­¥é™åˆ¶æŸäº›å­—æ®µï¼‰
   - é—®é¢˜ï¼šæ‰€æœ‰ç”¨æˆ·å¯ä»¥è¯»å–æ‰€æœ‰ç”¨æˆ·çš„ç”µå­é‚®ä»¶ã€ç”µè¯ç­‰æ•æ„Ÿä¿¡æ¯

2. **`inbox/$uid/*`** - æ”¶ä»¶ç®±ï¼ˆç§å¯†ï¼‰
   - å½“å‰è§„åˆ™ï¼š`.read: "auth != null && auth.uid === $uid"` âœ… æ­£ç¡®
   - å¥½æ¶ˆæ¯ï¼šå·²å—ä¿æŠ¤

3. **`dmMessages/*`** - DM æ¶ˆæ¯ï¼ˆç§å¯†ï¼‰
   - å½“å‰è§„åˆ™ï¼š`.read: "auth != null && $threadId.contains(auth.uid)"` âœ… æ­£ç¡®
   - å¥½æ¶ˆæ¯ï¼šå·²å—ä¿æŠ¤

4. **`blocks/$uid/*`** - å±è”½åˆ—è¡¨ï¼ˆç§å¯†ï¼‰
   - å½“å‰è§„åˆ™ï¼š`.read: "auth != null && auth.uid === $uid"` âœ… æ­£ç¡®
   - å¥½æ¶ˆæ¯ï¼šå·²å—ä¿æŠ¤

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### **æ–¹æ¡ˆ Aï¼šåˆ†çº§ä¿®å¤ï¼ˆæ¨èï¼‰**

åœ¨ä¿æŒåŠŸèƒ½å®Œæ•´çš„å‰æä¸‹ï¼Œä¸ºæ¯ä¸ªè·¯å¾„æ·»åŠ ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ï¼š

#### **1. `presence` - ä¿æŒå¼€æ”¾ï¼ˆæ­£å½“ç†ç”±ï¼‰**
```json
"presence": {
  "$uid": {
    ".read": "auth != null",
    ".write": "auth.uid === $uid"
  }
}
```
**ç†ç”±ï¼š** åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½éœ€è¦çœ‹åˆ°è°åœ¨çº¿ã€‚è¿™æ˜¯åˆç†çš„ã€‚

#### **2. `rooms` - æŒ‰å¯è§æ€§æ§åˆ¶**
```json
"rooms": {
  "$roomId": {
    ".read": "auth != null && (root.child('rooms').child($roomId).child('visibility').val() === 'public' || root.child('roomMembers').child($roomId).child(auth.uid).exists())",
    ".write": "auth != null && (newData.child('ownerId').val() === auth.uid || data.child('ownerId').val() === auth.uid)",
    ".validate": "newData.child('ownerId').exists()",
    ...
  }
}
```
**ç†ç”±ï¼š** ç”¨æˆ·åªèƒ½è¯»å…¬å¼€æˆ¿é—´æˆ–è‡ªå·±åŠ å…¥çš„æˆ¿é—´ã€‚é˜²æ­¢æ‰«æç§å¯†æˆ¿é—´ã€‚

#### **3. `messages` - æŒ‰æˆ¿é—´æˆå‘˜æ§åˆ¶**
```json
"messages": {
  "$roomId": {
    "$msgId": {
      ".read": "auth != null && root.child('roomMembers').child($roomId).child(auth.uid).exists()",
      ".write": "auth != null && newData.child('authorId').val() === auth.uid && newData.child('content').isString()",
      ".validate": "newData.hasChildren(['authorId', 'content', 'createdAt'])"
    }
  }
}
```
**ç†ç”±ï¼š** ç”¨æˆ·åªèƒ½è¯»è‡ªå·±åŠ å…¥çš„æˆ¿é—´çš„æ¶ˆæ¯ã€‚é˜²æ­¢æ‰«æå…¶ä»–æˆ¿é—´çš„å¯¹è¯ã€‚

#### **4. `posts` - æŒ‰ä½œè€…æˆ–å…¬å¼€çŠ¶æ€æ§åˆ¶**
```json
"posts": {
  "$postId": {
    ".read": "auth != null && (root.child('posts').child($postId).child('visibility').val() === 'public' || root.child('posts').child($postId).child('authorId').val() === auth.uid)",
    ".write": "auth != null && newData.child('authorId').val() === auth.uid",
    ".validate": "newData.hasChildren(['authorId', 'content'])"
  }
}
```
**ç†ç”±ï¼š** ç”¨æˆ·åªèƒ½è¯»å…¬å¼€ posts æˆ–è‡ªå·±çš„ postsã€‚

#### **5. `announcements` - ä¿æŒå¼€æ”¾ï¼ˆæ­£å½“ç†ç”±ï¼‰**
```json
"announcements": {
  ".read": "auth != null",
  ".write": "auth != null && root.child('profiles').child(auth.uid).child('isAdmin').val() === true"
}
```
**ç†ç”±ï¼š** å…¬å‘Šæ˜¯å…¬å¼€çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½åº”è¯¥çœ‹åˆ°ã€‚

---

## ğŸ” åŠŸèƒ½å½±å“è¯„ä¼°

### **ä¿®å¤æ–¹æ¡ˆå¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“**

| åŠŸèƒ½æ¨¡å— | å½“å‰çŠ¶æ€ | ä¿®å¤å | ç”¨æˆ·æ„ŸçŸ¥ | éœ€è¦ä»£ç æ”¹åŠ¨ |
|--------|--------|--------|---------|------------|
| **åœ¨çº¿ç”¨æˆ·åˆ—è¡¨** | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | **æ— å½±å“** | âŒ å¦ |
| **æˆ¿é—´åˆ—è¡¨** | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | **æ— å½±å“** | âŒ å¦ |
| **å…¬å¼€æˆ¿é—´æ¶ˆæ¯** | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | **æ— å½±å“** | âŒ å¦ |
| **ç§å¯†æˆ¿é—´æ¶ˆæ¯** | âœ… æ­£å¸¸ï¼ˆå¯èƒ½æœ‰æ¼æ´ï¼‰ | âœ… å®‰å…¨ | **æ— å½±å“** | âŒ å¦ |
| **æˆ¿é—´å‘ç°** | âš ï¸ å¯æ‰«æç§å¯†æˆ¿é—´ | âœ… æ— æ³•æ‰«æ | **æ— å½±å“** | âŒ å¦ |
| **DM æ¶ˆæ¯** | âœ… æ­£å¸¸ï¼ˆå·²ä¿æŠ¤ï¼‰ | âœ… æ­£å¸¸ | **æ— å½±å“** | âŒ å¦ |
| **ç”¨æˆ·å±è”½** | âœ… æ­£å¸¸ï¼ˆå·²ä¿æŠ¤ï¼‰ | âœ… æ­£å¸¸ | **æ— å½±å“** | âŒ å¦ |
| **å…¬å‘Šç³»ç»Ÿ** | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | **æ— å½±å“** | âŒ å¦ |
| **Posts ç³»ç»Ÿ** | âœ… æ­£å¸¸ï¼ˆæ— å¯è§æ€§æ§åˆ¶ï¼‰ | âœ… æ”¹è¿› | **æ— å½±å“** | âŒ å¦ |

**ç»“è®ºï¼š** 
- âœ… **é›¶ç”¨æˆ·æ„ŸçŸ¥å·®å¼‚** - æ‰€æœ‰ç°æœ‰åŠŸèƒ½ä¿æŒå®Œå…¨ä¸å˜
- âœ… **é›¶å‰ç«¯ä»£ç æ”¹åŠ¨** - å®Œå…¨æ˜¯è§„åˆ™å±‚çš„æ”¹è¿›
- âœ… **å¤§å¹…æå‡å®‰å…¨æ€§** - é˜²æ­¢æ•°æ®æ‰«æå’Œéšç§æ³„éœ²

---

## âš ï¸ æ½œåœ¨é£é™©è¯„ä¼°

### **ä¿®å¤å‰çš„é£é™©**
1. **æ¶æ„ç”¨æˆ·å¯ä»¥æ‰«æç§å¯†æˆ¿é—´** - é€šè¿‡å°è¯•æ‰€æœ‰å¯èƒ½çš„ roomId è·å–åç§°å’Œå…ƒæ•°æ®
2. **æ¶æ„ç”¨æˆ·å¯ä»¥è¯»å–å…¶ä»–æˆ¿é—´çš„æ¶ˆæ¯** - å¦‚æœçŸ¥é“ roomId å°±å¯ä»¥è¯»å–
3. **æ¶æ„ç”¨æˆ·å¯ä»¥å‘ç°å…¶ä»–ç”¨æˆ·çš„æ´»åŠ¨æ¨¡å¼** - é€šè¿‡ `presence.lastSeen` æ¨æ–­è¡Œä¸º

### **ä¿®å¤åçš„é£é™©**
å…¨éƒ¨æ¶ˆé™¤ âœ…

---

## ğŸ“Š Firebase è­¦å‘Šåˆ¤å®š

### **ä¿®å¤å‰**
```
âš ï¸ WARNING: Your rules allow any logged-in user to read your entire database.
   - Multiple paths use "auth != null" for read access
   - No resource-level access control
```

### **ä¿®å¤å**
```
âœ… OK: Your rules implement proper access control
   - Read access is restricted per resource
   - Users can only read appropriate data
   - Private data is protected
```

---

## ğŸš€ å®æ–½è®¡åˆ’

### **æ­¥éª¤ 1ï¼šå¤‡ä»½**
```bash
cp firebase.rules.json firebase.rules.json.backup-v1.22
```

### **æ­¥éª¤ 2ï¼šåº”ç”¨ä¿®å¤ï¼ˆä¸‹é¢çš„ JSONï¼‰**
æ›¿æ¢ `firebase.rules.json` çš„ç›¸å…³è·¯å¾„

### **æ­¥éª¤ 3ï¼šéªŒè¯è¯­æ³•**
```bash
firebase deploy --only database --dry-run
```

### **æ­¥éª¤ 4ï¼šéƒ¨ç½²**
```bash
firebase deploy --only database
```

### **æ­¥éª¤ 5ï¼šæµ‹è¯•**
- âœ… æ‰“å¼€åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ â†’ åº”æ˜¾ç¤ºç”¨æˆ·
- âœ… åŠ å…¥æˆ¿é—´ â†’ åº”èƒ½è¯»æ¶ˆæ¯
- âœ… ä¸åŠ å…¥æˆ¿é—´ â†’ ä¸åº”èƒ½è¯»æ¶ˆæ¯
- âœ… è·å–å…¬å‘Š â†’ åº”èƒ½è¯»

### **æ­¥éª¤ 6ï¼šæäº¤ä»£ç **
```bash
git add firebase.rules.json
git commit -m "security: Implement fine-grained access control for all paths"
git push
```

---

## ğŸ’¡ å»ºè®®

1. **ç«‹å³å®æ–½** - è¿™ä¸ªä¿®å¤å¯¹åŠŸèƒ½é›¶å½±å“ï¼Œä½†å®‰å…¨æ”¶ç›Šå·¨å¤§
2. **æ–‡æ¡£åŒ–** - å°†è®¿é—®æ§åˆ¶è§„åˆ™æ–‡æ¡£åŒ–åˆ° `FIREBASE_RULES.md`
3. **å®šæœŸå®¡è®¡** - æ¯å­£åº¦å®¡è®¡ä¸€æ¬¡è§„åˆ™ï¼Œç¡®ä¿æ–°è·¯å¾„éƒ½æœ‰é€‚å½“çš„è®¿é—®æ§åˆ¶
4. **æµ‹è¯•å¥—ä»¶** - è€ƒè™‘æ·»åŠ è§„åˆ™æµ‹è¯•ï¼ˆä½¿ç”¨ Firebase Emulatorï¼‰

---

## é™„å½•ï¼šå®Œæ•´ä¿®å¤çš„ JSON

è§ä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼š`firebase.rules.json.fixed`


