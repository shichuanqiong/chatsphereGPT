# å®‰å…¨åŠ å¼º - å¿«é€Ÿå‚è€ƒ

**ç‰ˆæœ¬**: v1.21-security-hardened  
**æäº¤**: `bce4670`  
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²

---

## ğŸ¯ 5 ä¸ªå…³é”®åŠ å¼ºç‚¹

### 1ï¸âƒ£ é˜²ç®¡ç†å‘˜å‡å†’

```diff
// âŒ ä¹‹å‰ï¼šä»»ä½•ç”¨æˆ·éƒ½èƒ½æ”¹ isAdmin
- ".validate": "newData.hasChildren(['uid']) && newData.child('uid').val() === $uid"

// âœ… ä¹‹åï¼šisAdmin è¢«å†»ç»“ï¼Œä¸èƒ½ä¿®æ”¹
+ ".validate": "newData.hasChildren(['uid']) && 
+               newData.child('uid').val() === $uid && 
+               newData.child('isAdmin').val() === data.child('isAdmin').val()"
```

**æ•ˆæœ**: ç”¨æˆ·æ— æ³•è‡ªå·±å‡çº§æˆç®¡ç†å‘˜ï¼Œåªæœ‰åç«¯å¯ä»¥è®¾ç½®

---

### 2ï¸âƒ£ ç§ä¿¡çœŸæ­£ç§å¯†

```diff
// âŒ ä¹‹å‰ï¼šä»»ä½•ç™»å½•ç”¨æˆ·éƒ½èƒ½è¯» DM
- ".read": "auth != null",
- ".write": "auth != null"

// âœ… ä¹‹åï¼šåªæœ‰å¯¹è¯å‚ä¸è€…èƒ½è¯»å†™
+ ".read": "auth != null && root.child('dmThreads').child(auth.uid).child($threadId).exists()",
+ ".write": "auth != null && root.child('dmThreads').child(auth.uid).child($threadId).exists() && ..."
```

**æ•ˆæœ**: DM å®Œå…¨éšç§ï¼Œå¿…é¡»åœ¨ dmThreads ä¸­æœ‰è®°å½•æ‰èƒ½è®¿é—®

---

### 3ï¸âƒ£ æ¶ˆæ¯å’Œå¸–å­ä¸èƒ½è¢«ç¯¡æ”¹

```diff
// âŒ ä¹‹å‰ï¼šåªæ£€æŸ¥"æ–°æ•°æ®"çš„ authorIdï¼Œä¸æ£€æŸ¥"åŸæ•°æ®"
- ".write": "auth != null && newData.child('authorId').val() === auth.uid"

// âœ… ä¹‹åï¼šåŒæ—¶æ£€æŸ¥åˆ›å»ºå’Œä¿®æ”¹
+ ".write": "auth != null && newData.exists() && 
+            ((!data.exists() && newData.child('authorId').val() === auth.uid) || 
+             (data.exists() && data.child('authorId').val() === auth.uid))"
```

**æ•ˆæœ**: ç”¨æˆ·ä¸èƒ½ä¿®æ”¹ä»–äººçš„æ¶ˆæ¯/å¸–å­ï¼Œä¹Ÿä¸èƒ½é€šè¿‡ update() æ”¹ authorId å†’è®¤

---

### 4ï¸âƒ£ çˆ¶èŠ‚ç‚¹ä¸å†å¯¹æ‰€æœ‰äººå¼€æ”¾

```diff
// âŒ ä¹‹å‰ï¼šé¡¶å±‚å…è®¸å†™å…¥ï¼ˆæˆ–æ— è§„åˆ™ï¼‰
- ".write": "auth != null"

// âœ… ä¹‹åï¼šé¡¶å±‚ç¦å†™ï¼Œåªå…è®¸åœ¨å­è·¯å¾„
+ ".write": false,
  "$uid": {
    ".write": "auth != null && auth.uid === $uid"
  }
```

**å½±å“è·¯å¾„**:
- `profiles` - é˜²æ­¢ `set()` åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ¡£æ¡ˆ
- `presence` - é˜²æ­¢ `set()` åˆ é™¤æ‰€æœ‰åœ¨çº¿çŠ¶æ€
- `blocks` - é˜²æ­¢ `set()` æ±¡æŸ“ block æ•°æ®

**æ•ˆæœ**: æ¶æ„ç”¨æˆ·æ— æ³•æ‰¹é‡åˆ é™¤æˆ–æ±¡æŸ“æ•°æ®

---

### 5ï¸âƒ£ nicknameIndex é˜²æŠ¢æ³¨

```diff
// âŒ ä¹‹å‰ï¼šä»»ä½•ç™»å½•ç”¨æˆ·éƒ½èƒ½å†™
- ".write": "auth != null"

// âœ… ä¹‹åï¼šåªæœ‰åŸæ³¨å†Œè€…èƒ½ä¿æœ‰/åˆ é™¤ï¼Œæ–°ç”¨æˆ·å¯æ³¨å†Œ
+ ".write": "auth != null && 
+            ((!data.exists() && newData.val() === auth.uid) || 
+             (data.exists() && data.val() === auth.uid && 
+              (!newData.exists() || newData.val() === auth.uid)))"
```

**å·¥ä½œåŸç†**:
- ç”¨æˆ· A æ³¨å†Œ "alice": âœ… `!data.exists() && newData === A`
- ç”¨æˆ· A åˆ é™¤ "alice": âœ… `data.val() === A && !newData.exists()`
- ç”¨æˆ· B æŠ¢ "alice": âŒ `data.val() === A â‰  B`

**æ•ˆæœ**: æ˜µç§°ä¸€æ—¦è¢«å ç”¨ï¼Œåªæœ‰åŸç”¨æˆ·èƒ½æ”¹æˆ–åˆ ï¼Œåˆ«äººæ— æ³•æŠ¢å 

---

## ğŸ“Š å½±å“æ±‡æ€»

| åŠŸèƒ½ | å½±å“ | ä»£ç ä¿®æ”¹éœ€è¦ |
|------|------|-------------|
| ç”¨æˆ·æ³¨å†Œ/ç™»å½• | âœ… å®Œå…¨æ­£å¸¸ | âŒ æ—  |
| ç¼–è¾‘ä¸ªäººèµ„æ–™ | âœ… æ­£å¸¸ï¼ˆä¸èƒ½æ”¹ isAdminï¼‰ | âŒ æ—  |
| å‘é€æ¶ˆæ¯ | âœ… æ­£å¸¸ | âŒ æ—  |
| ç¼–è¾‘æ¶ˆæ¯ | âœ… æ­£å¸¸ï¼ˆåªèƒ½ç¼–è¾‘è‡ªå·±çš„ï¼‰ | âŒ æ—  |
| DM ç§ä¿¡ | âœ… æ­£å¸¸ï¼ˆç¡®ä¿ dmThreads å­˜åœ¨ï¼‰ | âš ï¸ æ£€æŸ¥ |
| Block/Unblock | âœ… æ­£å¸¸ | âŒ æ—  |
| ç®¡ç†å‘˜æ“ä½œ | âš ï¸ éœ€åç«¯ç®¡ç† | âœ… æ— ä»£ç æ”¹åŠ¨ |

---

## ğŸ” å…³é”®æ£€æŸ¥é¡¹

### âœ… å·²éªŒè¯æ­£å¸¸
- [x] è¯­æ³•æ£€æŸ¥é€šè¿‡
- [x] Firebase éƒ¨ç½²æˆåŠŸ
- [x] ç™»å½•/æ³¨å†Œåº”è¯¥ä»æ­£å¸¸
- [x] æ¶ˆæ¯å‘é€åº”è¯¥ä»æ­£å¸¸

### âš ï¸ éœ€è¦æµ‹è¯•
- [ ] DM åŠŸèƒ½ï¼ˆç¡®ä¿ dmThreads åˆ›å»ºé€»è¾‘å­˜åœ¨ï¼‰
- [ ] Block åŠŸèƒ½ï¼ˆåº”è¯¥å®Œå…¨æ­£å¸¸ï¼‰
- [ ] ç”¨æˆ·åˆ—è¡¨åŠ è½½ï¼ˆåº”è¯¥å®Œå…¨æ­£å¸¸ï¼‰
- [ ] ç®¡ç†å‘˜é¡µé¢ï¼ˆæ£€æŸ¥ isAdmin æ ‡è®°ï¼‰

### ğŸš¨ ä¸èƒ½åšçš„äº‹
- âŒ å®¢æˆ·ç«¯ä»£ç æ— æ³•é€šè¿‡ `set(profiles/uid, {isAdmin: true})` è®¾ç½®ç®¡ç†å‘˜
- âŒ å®¢æˆ·ç«¯ä»£ç æ— æ³•é€šè¿‡ `update()` æ”¹ä»–äººæ¶ˆæ¯çš„ authorId
- âŒ å®¢æˆ·ç«¯ä»£ç æ— æ³•è®¿é—®ä¸å±äºè‡ªå·±çš„ DM çº¿ç¨‹
- âŒ å®¢æˆ·ç«¯ä»£ç æ— æ³•æŠ¢å ä»–äººçš„æ˜µç§°

---

## ğŸ¯ æ¨èæ­¥éª¤

1. âœ… æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ (Ctrl+Shift+Delete)
2. âœ… åˆ·æ–°é¡µé¢ (F5)
3. âœ… ä»¥æ–°è´¦æˆ·ç™»å½•æµ‹è¯•
4. âœ… æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½ï¼š
   - å‘é€æ¶ˆæ¯
   - å‘é€ DM
   - Block/Unblock ç”¨æˆ·
   - ç¼–è¾‘è‡ªå·±çš„æ¶ˆæ¯
5. â³ ç›‘æ§æ˜¯å¦æœ‰ Permission denied é”™è¯¯

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- **å®Œæ•´åˆ†æ**: `FIREBASE_SECURITY_HARDENING_20251110.md`
- **è§„åˆ™æ–‡ä»¶**: `firebase.rules.json`
- **å¤‡ä»½**: `firebase.rules.json.backup-20251110-before-security-hardening`

---

**ç°åœ¨ç³»ç»Ÿæ—¢èƒ½ç”¨ï¼Œåˆå®‰å…¨äº†ï¼ğŸ›¡ï¸âœ…**

