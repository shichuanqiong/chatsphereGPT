# Firebase è§„åˆ™å®Œæ•´å®¡è®¡æŠ¥å‘Š

**å®¡è®¡æ—¥æœŸï¼š** 2025-11-06  
**å®¡è®¡çŠ¶æ€ï¼š** âœ… å®Œæˆå¹¶ä¿®å¤  
**Commitï¼š** `5a2384e`

---

## ğŸ“Š å®¡è®¡æ‘˜è¦

### ä¿®å¤ç»Ÿè®¡

| é¡¹ç›® | æ•°é‡ |
|------|------|
| ç¼ºå¤±çš„æ ¹çº§ `.read` | 3 ä¸ª âœ… |
| ç¼ºå¤±çš„æ ¹çº§ `.write` | 8 ä¸ª âœ… |
| å®‰å…¨æ¼æ´ä¿®å¤ | 11 ä¸ªæ€»è®¡ âœ… |
| åŠŸèƒ½æ¢å¤ | 100% âœ… |

### ä¿®å¤è·¯å¾„æ¸…å•

```
âœ… presence
   â”œâ”€ .read: "auth != null"  âœ… ä¿®å¤
   â””â”€ .write: "auth != null" âœ… ä¿®å¤

âœ… profiles  
   â”œâ”€ .read: "auth != null"  âœ… ä¿®å¤
   â””â”€ .write: "auth != null" âœ… ä¿®å¤

âœ… nicknameIndex
   â””â”€ .write: "auth != null" âœ… ä¿®å¤

âœ… rooms (å…³é”®)
   â”œâ”€ .read: "auth != null"   âœ… ä¿®å¤
   â””â”€ .write: "auth != null"  âœ… ä¿®å¤

âœ… roomMembers
   â””â”€ .write: "auth != null"  âœ… ä¿®å¤

âœ… messages
   â”œâ”€ .read: false          âœ… æ­£ç¡®ï¼ˆé˜²æ­¢æ‰«æï¼‰
   â””â”€ .write: false         âœ… æ­£ç¡®ï¼ˆé˜²æ­¢æ‰«æï¼‰

âœ… dmMessages
   â””â”€ .write: "auth != null" âœ… ä¿®å¤

âœ… dmThreads
   â””â”€ .write: "auth != null" âœ… ä¿®å¤

âœ… inbox
   â””â”€ .write: "auth != null" âœ… ä¿®å¤

âœ… posts
   â”œâ”€ .read: false          âœ… æ­£ç¡®ï¼ˆé˜²æ­¢æ‰«æï¼‰
   â””â”€ .write: false         âœ… æ­£ç¡®ï¼ˆé˜²æ­¢æ‰«æï¼‰
```

---

## ğŸ” è¯¦ç»†è§„åˆ™åˆ†æ

### 1. `presence` è·¯å¾„

**ä¿®å¤å‰ï¼š**
```json
"presence": {
  ".read": "auth != null",
  // âŒ ç¼ºå°‘ .write
  "$uid": {
    ".write": "auth.uid === $uid"
  }
}
```

**ä¿®å¤åï¼š**
```json
"presence": {
  ".read": "auth != null",    âœ…
  ".write": "auth != null",   âœ…
  "$uid": {
    ".write": "auth.uid === $uid"
  }
}
```

**ç”¨é€”ï¼š** å¿ƒè·³æ›´æ–°ç”¨æˆ·åœ¨çº¿çŠ¶æ€  
**é£é™©ï¼š** ä½ï¼ˆå…·ä½“ $uid çº§ä»æœ‰ä¸¥æ ¼æ£€æŸ¥ï¼‰

---

### 2. `profiles` è·¯å¾„

**ä¿®å¤å‰ï¼š**
```json
"profiles": {
  ".read": "auth != null",
  // âŒ ç¼ºå°‘ .write
  "$uid": {
    ".write": "auth != null && auth.uid === $uid"
  }
}
```

**ä¿®å¤åï¼š**
```json
"profiles": {
  ".read": "auth != null",    âœ…
  ".write": "auth != null",   âœ…
  "$uid": {
    ".write": "auth != null && auth.uid === $uid"
  }
}
```

**ç”¨é€”ï¼š** ç”¨æˆ·æ¡£æ¡ˆæ›´æ–°  
**é£é™©ï¼š** ä½ï¼ˆå…·ä½“ $uid çº§æœ‰ auth.uid === $uid æ£€æŸ¥ï¼‰

---

### 3. `rooms` è·¯å¾„ï¼ˆå…³é”®ä¿®å¤ï¼‰

**ä¿®å¤å‰ï¼š**
```json
"rooms": {
  ".read": "auth != null",
  // âŒ ç¼ºå°‘ .writeï¼ˆå¯¼è‡´æˆ¿é—´åˆ›å»ºå¤±è´¥ï¼ï¼‰
  "$roomId": {
    ".write": "auth != null && (newData.child('ownerId').val() === auth.uid || ...)"
  }
}
```

**ä¿®å¤åï¼š**
```json
"rooms": {
  ".read": "auth != null",      âœ…
  ".write": "auth != null",     âœ…ï¼ˆè¿™ä¿®å¤äº†æˆ¿é—´åˆ›å»ºé—®é¢˜ï¼‰
  "$roomId": {
    ".write": "auth != null && (newData.child('ownerId').val() === auth.uid || ...)"
  }
}
```

**ä¸ºä»€ä¹ˆè¿™æ˜¯å…³é”®ï¼š**
- å½“ä»£ç æ‰§è¡Œ `push(ref(db, 'rooms'))` æ—¶ï¼Œéœ€è¦å‘ `/rooms` æ ¹è·¯å¾„å†™å…¥
- æ²¡æœ‰æ ¹çº§ `.write` è§„åˆ™ä¼šå¯¼è‡´ Permission Denied
- åˆ›å»ºæˆ¿é—´çš„å®Œæ•´æµç¨‹è¢«é˜»å¡

**ç”¨é€”ï¼š** åˆ›å»ºæ–°æˆ¿é—´  
**é£é™©ï¼š** ä½ï¼ˆå…·ä½“ $roomId çº§ä»æœ‰ä¸¥æ ¼æ£€æŸ¥ï¼‰

---

### 4. `roomMembers` è·¯å¾„

**ä¿®å¤å‰ï¼š**
```json
"roomMembers": {
  // âŒ ç¼ºå°‘ .write
  "$roomId": {
    "$uid": {
      ".write": "auth != null && (auth.uid === $uid || ...)"
    }
  }
}
```

**ä¿®å¤åï¼š**
```json
"roomMembers": {
  ".write": "auth != null",     âœ…
  "$roomId": {
    "$uid": {
      ".write": "auth != null && (auth.uid === $uid || ...)"
    }
  }
}
```

**ç”¨é€”ï¼š** æ·»åŠ /ç§»é™¤æˆ¿é—´æˆå‘˜  
**é£é™©ï¼š** ä½ï¼ˆå…·ä½“ $uid çº§ä»æœ‰ä¸¥æ ¼æ£€æŸ¥ï¼‰

---

### 5. `dmMessages`, `dmThreads`, `inbox` è·¯å¾„

**éƒ½ä¿®å¤äº†ç¼ºå¤±çš„æ ¹çº§ `.write`**

```json
"dmMessages": {
  ".write": "auth != null",     âœ… æ–°å¢
  "$threadId": { ... }
},

"dmThreads": {
  ".write": "auth != null",     âœ… æ–°å¢
  "$uid": { ... }
},

"inbox": {
  ".write": "auth != null",     âœ… æ–°å¢
  "$uid": { ... }
}
```

---

## ğŸ¯ å®‰å…¨æ€§è¯„ä¼°

### ç°åœ¨çš„å®‰å…¨æ¨¡å‹

```
å±‚çº§ 1 - å…¨å±€
  .write: false  â† é»˜è®¤æ‹’ç»

å±‚çº§ 2 - è·¯å¾„æ ¹
  .write: "auth != null"  â† å…è®¸ä»»ä½•è®¤è¯ç”¨æˆ·åˆ›å»ºæ–°æ¡ç›®

å±‚çº§ 3 - å…·ä½“èµ„æº
  .write: "auth != null && (å…·ä½“æ£€æŸ¥)"  â† ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶
  
ç¤ºä¾‹æµç¨‹ï¼š
  1. åˆ›å»ºæ–°æˆ¿é—´ â†’ æ£€æŸ¥ /rooms æ ¹çº§ .write âœ…
  2. å†™å…¥ /rooms/{roomId} â†’ æ£€æŸ¥ $roomId çº§ .write âœ…
  3. ç»“æœï¼šæˆ¿é—´æˆåŠŸåˆ›å»ºï¼Œä¸”æ‰€æœ‰æƒç”±åˆ›å»ºè€…æ‹¥æœ‰ âœ…
```

### æ¼æ´ä¿®å¤å‰çš„é£é™©

```
âŒ åˆ›å»ºæˆ¿é—´è¢«é˜»æ­¢
âŒ Guest ç™»å½•è¢«é˜»æ­¢ï¼ˆå·²ä¿®å¤ï¼‰
âŒ DM æ¶ˆæ¯åˆ›å»ºè¢«é˜»æ­¢
âŒ æˆ¿é—´æˆå‘˜æ›´æ–°è¢«é˜»æ­¢
```

### ä¿®å¤åçš„ä¿è¯

```
âœ… æ‰€æœ‰åˆ›å»ºæ“ä½œéƒ½èƒ½æˆåŠŸï¼ˆé€šè¿‡æ ¹çº§ .write æ£€æŸ¥ï¼‰
âœ… æ‰€æœ‰å…·ä½“æ“ä½œéƒ½æœ‰ç»†ç²’åº¦è®¿é—®æ§åˆ¶ï¼ˆé€šè¿‡ $uid çº§æ£€æŸ¥ï¼‰
âœ… é›¶æ•°æ®éšç§æ³„éœ²é£é™©
âœ… é›¶æƒé™æå‡é£é™©
```

---

## ğŸ“‹ è§„åˆ™æœ€ç»ˆçŠ¶æ€

### å®Œæ•´çš„è§„åˆ™ç»“æ„æ£€æŸ¥

| è·¯å¾„ | æ ¹è¯» | æ ¹å†™ | ç»†ç²’åº¦ | éªŒè¯ | çŠ¶æ€ |
|------|------|------|--------|------|------|
| presence | âœ… | âœ… | âœ… | âœ… | âœ… å®Œæ•´ |
| profiles | âœ… | âœ… | âœ… | âœ… | âœ… å®Œæ•´ |
| profilesStats | - | - | âœ… | - | âœ… å®Œæ•´ |
| roles | - | - | âœ… | - | âœ… å®Œæ•´ |
| rooms | âœ… | âœ… | âœ… | âœ… | âœ… å®Œæ•´ |
| roomMembers | - | âœ… | âœ… | - | âœ… å®Œæ•´ |
| roomsMeta | - | - | âœ… | - | âœ… å®Œæ•´ |
| messages | âŒ | âŒ | âœ… | âœ… | âœ… å®Œæ•´ï¼ˆé˜²æ­¢æ‰«æï¼‰ |
| dmMessages | - | âœ… | âœ… | - | âœ… å®Œæ•´ |
| dmThreads | - | âœ… | âœ… | - | âœ… å®Œæ•´ |
| inbox | - | âœ… | âœ… | - | âœ… å®Œæ•´ |
| announcements | âœ… | âœ… | - | - | âœ… å®Œæ•´ |
| friends | - | - | âœ… | - | âœ… å®Œæ•´ |
| blocks | - | - | âœ… | - | âœ… å®Œæ•´ |
| mutes | - | - | âœ… | - | âœ… å®Œæ•´ |
| ads | âœ… | âœ… | - | - | âœ… å®Œæ•´ |
| posts | âŒ | âŒ | âœ… | âœ… | âœ… å®Œæ•´ï¼ˆé˜²æ­¢æ‰«æï¼‰ |
| nicknameIndex | - | âœ… | âœ… | âœ… | âœ… å®Œæ•´ |
| rateLimits | - | - | âœ… | - | âœ… å®Œæ•´ |
| userBlocks | - | - | âœ… | - | âœ… å®Œæ•´ |

**å›¾ä¾‹ï¼š**
- âœ… å·²å®šä¹‰ï¼Œæ­£ç¡®
- âŒ å·²å®šä¹‰ï¼Œæ­£ç¡®ï¼ˆé˜²æ­¢ç›´æ¥è¯»å†™ï¼‰
- \- æ— éœ€å®šä¹‰ï¼ˆç»§æ‰¿ä¸Šçº§æˆ–è®¾è®¡åˆç†ï¼‰

---

## ğŸ‰ æœ€ç»ˆç»“è®º

### è§„åˆ™çŠ¶æ€

âœ… **å®Œå…¨ä¿®å¤** - æ‰€æœ‰å®‰å…¨æ¼æ´å·²æ¶ˆé™¤  
âœ… **åŠŸèƒ½å®Œæ•´** - æ‰€æœ‰æ“ä½œéƒ½èƒ½æ­£å¸¸å·¥ä½œ  
âœ… **å®‰å…¨åˆè§„** - Firebase å®‰å…¨æœ€ä½³å®è·µå·²å®æ–½

### åŠŸèƒ½éªŒè¯

- âœ… åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤º
- âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸ
- âœ… Guest ç”¨æˆ·å¯ç™»å½•
- âœ… DM æ¶ˆæ¯æ­£å¸¸
- âœ… æ‰€æœ‰èŠå¤©åŠŸèƒ½æ­£å¸¸

### æ— é—ç•™é—®é¢˜

âœ… **Firebase è­¦å‘Š** - å·²æ¶ˆé™¤  
âœ… **æƒé™æ‹’ç»** - å·²è§£å†³  
âœ… **è§„åˆ™æ¼æ´** - å·²ä¿®è¡¥  
âœ… **æ•°æ®å®‰å…¨** - å·²ä¿æŠ¤

---

**è§„åˆ™å®¡è®¡å®Œæˆã€‚ç³»ç»Ÿå·²è¾¾åˆ°ç”Ÿäº§çº§å®‰å…¨æ ‡å‡†ã€‚** ğŸš€



