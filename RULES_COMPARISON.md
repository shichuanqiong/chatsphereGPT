# Firebase è§„åˆ™å¯¹æ¯” - ä¿®å¤å‰å

## å…³é”®è·¯å¾„æ”¹åŠ¨å¯¹æ¯”

### 1. `messages` è·¯å¾„ï¼ˆæœ€ä¸¥é‡ï¼‰

#### âŒ ä¿®å¤å‰
```json
"messages": {
  "$roomId": {
    "$msgId": {
      ".read": "auth != null",  // âš ï¸ ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½å¯è¯»ï¼
      ".write": "auth != null && newData.child('authorId').val() === auth.uid && newData.child('content').isString()",
      ".validate": "newData.hasChildren(['authorId', 'content', 'createdAt'])"
    }
  }
}
```

**é£é™©ï¼š** 
- ç”¨æˆ· A å¯ä»¥çŒœæµ‹æˆ¿é—´ ID
- ç”¨æˆ· A å¯ä»¥è¯»å–æˆ¿é—´çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œå³ä½¿æ²¡æœ‰åŠ å…¥
- å¯ä»¥çªƒå¬æ‰€æœ‰å¯¹è¯ ğŸš¨

#### âœ… ä¿®å¤å
```json
"messages": {
  "$roomId": {
    "$msgId": {
      ".read": "auth != null && root.child('roomMembers').child($roomId).child(auth.uid).exists()",  // âœ… ä»…æˆ¿é—´æˆå‘˜
      ".write": "auth != null && newData.child('authorId').val() === auth.uid && newData.child('content').isString()",
      ".validate": "newData.hasChildren(['authorId', 'content', 'createdAt'])"
    }
  }
}
```

**æ”¹è¿›ï¼š**
- ç”¨æˆ·å¿…é¡»æ˜¯æˆ¿é—´æˆå‘˜æ‰èƒ½è¯»æ¶ˆæ¯
- é˜²æ­¢æ¶ˆæ¯çªƒå¬
- éšç§å®Œå…¨ä¿æŠ¤ âœ…

**åŠŸèƒ½å½±å“ï¼š** âœ… é›¶ - æ­£å¸¸ç”¨æˆ·å·²ç»æ˜¯æˆå‘˜ï¼Œä¸å—å½±å“

---

### 2. `rooms` è·¯å¾„ï¼ˆé«˜é£é™©ï¼‰

#### âŒ ä¿®å¤å‰
```json
"rooms": {
  "$roomId": {
    ".read": "auth != null",  // âš ï¸ ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½å¯è¯»ï¼
    ".write": "auth != null && (newData.child('ownerId').val() === auth.uid || data.child('ownerId').val() === auth.uid)",
    ".validate": "newData.child('ownerId').exists()",
    ...
  }
}
```

**é£é™©ï¼š**
- ç”¨æˆ·å¯ä»¥å‘ç°æ‰€æœ‰ç§å¯†æˆ¿é—´çš„å­˜åœ¨
- å¯ä»¥è·å–ç§å¯†æˆ¿é—´çš„åç§°ã€æè¿°ç­‰å…ƒæ•°æ®
- å¯ä»¥éšè”½åœ°æ¢æµ‹è°åˆ›å»ºäº†å“ªäº›æˆ¿é—´

#### âœ… ä¿®å¤å
```json
"rooms": {
  "$roomId": {
    ".read": "auth != null && (root.child('rooms').child($roomId).child('visibility').val() === 'public' || root.child('roomMembers').child($roomId).child(auth.uid).exists())",  // âœ… ä»…å…¬å¼€æˆ–è‡ªå·±åŠ å…¥çš„
    ".write": "auth != null && (newData.child('ownerId').val() === auth.uid || data.child('ownerId').val() === auth.uid)",
    ".validate": "newData.child('ownerId').exists()",
    ...
  }
}
```

**æ”¹è¿›ï¼š**
- ç”¨æˆ·åªèƒ½çœ‹åˆ°å…¬å¼€æˆ¿é—´
- ç§å¯†æˆ¿é—´éšè—
- æˆ¿é—´æ‰€æœ‰è€…éšç§ä¿æŠ¤ âœ…

**åŠŸèƒ½å½±å“ï¼š** âœ… é›¶ - ç”¨æˆ·åªä¼šçœ‹åˆ°åº”è¯¥çœ‹åˆ°çš„æˆ¿é—´

---

### 3. `posts` è·¯å¾„ï¼ˆä¸­ç­‰é£é™©ï¼‰

#### âŒ ä¿®å¤å‰
```json
"posts": {
  "$postId": {
    ".read": "auth != null",  // âš ï¸ ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½å¯è¯»ï¼
    ".write": "auth != null && newData.child('authorId').val() === auth.uid",
    ".validate": "newData.hasChildren(['authorId', 'content'])"
  }
}
```

**é£é™©ï¼š**
- ç”¨æˆ·å¯ä»¥å‘ç°æ‰€æœ‰ postsï¼ˆåŒ…æ‹¬ç§å¯†çš„ï¼‰
- å¯ä»¥é˜…è¯»ä»–äººçš„ç§å¯†ç¬”è®°

#### âœ… ä¿®å¤å
```json
"posts": {
  "$postId": {
    ".read": "auth != null && (root.child('posts').child($postId).child('visibility').val() === 'public' || root.child('posts').child($postId).child('authorId').val() === auth.uid)",  // âœ… ä»…å…¬å¼€æˆ–è‡ªå·±çš„
    ".write": "auth != null && newData.child('authorId').val() === auth.uid",
    ".validate": "newData.hasChildren(['authorId', 'content'])"
  }
}
```

**æ”¹è¿›ï¼š**
- ç”¨æˆ·åªèƒ½è¯»å…¬å¼€ posts
- è‡ªå·±çš„ç§å¯† posts å—ä¿æŠ¤
- ä»–äººéšç§ä¸æ³„éœ² âœ…

**åŠŸèƒ½å½±å“ï¼š** âœ… é›¶ - ç”¨æˆ·åªä¼šçœ‹åˆ°åº”è¯¥çœ‹åˆ°çš„ posts

---

## ä¸éœ€è¦ä¿®æ”¹çš„è·¯å¾„ï¼ˆå·²æ­£ç¡®ï¼‰

| è·¯å¾„ | è§„åˆ™ | è¯´æ˜ |
|------|------|------|
| `presence/$uid` | `.read: "auth != null"` | âœ… æ­£ç¡® - åœ¨çº¿åˆ—è¡¨åº”è¯¥å…¬å¼€ |
| `announcements` | `.read: "auth != null"` | âœ… æ­£ç¡® - å…¬å‘Šåº”è¯¥å¯¹æ‰€æœ‰ç”¨æˆ·å¯è§ |
| `dmMessages/$threadId` | `.read: $threadId.contains(auth.uid)` | âœ… æ­£ç¡® - ä»…å‚ä¸è€…å¯è¯» |
| `inbox/$uid` | `.read: auth.uid === $uid` | âœ… æ­£ç¡® - ä»…ä¸ªäººå¯è¯» |
| `blocks/$uid` | `.read: auth.uid === $uid` | âœ… æ­£ç¡® - ä»…ä¸ªäººå¯è¯» |
| `dmThreads/$uid` | `.read: auth.uid === $uid` | âœ… æ­£ç¡® - ä»…ä¸ªäººå¯è¯» |

---

## ğŸ“Š ä¿®å¤å½±å“åˆ†æ

### å®‰å…¨æ€§æ”¹è¿›

```
ä¿®å¤å‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»ä½•ç™»å½•ç”¨æˆ·        â”‚
â”‚  å¯è¯»æ‰€æœ‰æ•°æ®        â”‚  ğŸš¨ ä¸´ç•Œé£é™©
â”‚  (åŒ…æ‹¬ç§å¯†æ•°æ®)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¿®å¤åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ· A            â”‚
â”‚  â†“ å¯è¯»            â”‚  âœ… ç»†ç²’åº¦æ§åˆ¶
â”‚  â€¢ å…¬å¼€æˆ¿é—´æ¶ˆæ¯    â”‚
â”‚  â€¢ è‡ªå·±åŠ å…¥çš„æˆ¿é—´   â”‚
â”‚  â€¢ å…¬å¼€ posts       â”‚
â”‚  â€¢ è‡ªå·±çš„ç§å¯†æ•°æ®   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ· B            â”‚
â”‚  â†“ éšè—            â”‚
â”‚  â€¢ ç§å¯†æˆ¿é—´         â”‚
â”‚  â€¢ ä»–äººç§å¯†æ•°æ®     â”‚
â”‚  â€¢ ä»–äººçš„ posts     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŠŸèƒ½å®Œæ•´æ€§

```
ä¿®å¤å‰ååŠŸèƒ½å¯¹æ¯”ï¼š

âœ… å…¬å¼€æˆ¿é—´åˆ—è¡¨ - å®Œå…¨ç›¸åŒ
âœ… æˆ¿é—´æ¶ˆæ¯ - å®Œå…¨ç›¸åŒï¼ˆç”¨æˆ·å·²æ˜¯æˆå‘˜ï¼‰
âœ… åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ - å®Œå…¨ç›¸åŒ
âœ… DM æ¶ˆæ¯ - å®Œå…¨ç›¸åŒï¼ˆå·²å—ä¿æŠ¤ï¼‰
âœ… å…¬å‘Šç³»ç»Ÿ - å®Œå…¨ç›¸åŒ
âœ… ç”¨æˆ·å±è”½ - å®Œå…¨ç›¸åŒï¼ˆå·²å—ä¿æŠ¤ï¼‰

æ”¹è¿›ï¼š
ğŸ”’ ç§å¯†æˆ¿é—´ - ç°åœ¨éšè—ï¼ˆåŸæœ¬åº”è¯¥éšè—ï¼‰
ğŸ”’ ç§å¯† posts - ç°åœ¨éšè—ï¼ˆåŸæœ¬åº”è¯¥éšè—ï¼‰
ğŸ”’ ä»–äººæ¶ˆæ¯ - ç°åœ¨éšè—ï¼ˆåŸæœ¬åº”è¯¥éšè—ï¼‰
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šæ­£å¸¸ç”¨æˆ·åŠ å…¥æˆ¿é—´å¹¶èŠå¤©

**ä¿®å¤å‰ï¼š** âœ… å·¥ä½œæ­£å¸¸  
**ä¿®å¤åï¼š** âœ… å·¥ä½œæ­£å¸¸  
**ç»“è®ºï¼š** âœ… æ— å·®å¼‚

```
ç”¨æˆ· A åŠ å…¥æˆ¿é—´ room-123
ç”¨æˆ· A è¯» /messages/room-123/* 
â†’ âœ… å…è®¸ï¼ˆæ˜¯æˆ¿é—´æˆå‘˜ï¼‰
```

### åœºæ™¯ 2ï¼šæœªåŠ å…¥æˆ¿é—´çš„ç”¨æˆ·å°è¯•è¯»æ¶ˆæ¯

**ä¿®å¤å‰ï¼š** âš ï¸ å…è®¸ï¼ˆé£é™©ï¼ï¼‰  
**ä¿®å¤åï¼š** âŒ æ‹’ç»ï¼ˆå®‰å…¨ï¼‰  
**ç»“è®ºï¼š** âœ… æ”¹è¿›

```
ç”¨æˆ· B æœªåŠ å…¥æˆ¿é—´ room-456
ç”¨æˆ· B å°è¯•è¯» /messages/room-456/*
ä¿®å¤å‰ â†’ âœ… ALLOWED ï¼ˆå®‰å…¨é—®é¢˜ï¼ï¼‰
ä¿®å¤å â†’ âŒ DENIED ï¼ˆæ­£ç¡®è¡Œä¸ºï¼‰
```

### åœºæ™¯ 3ï¼šæŸ¥çœ‹å…¬å¼€æˆ¿é—´åˆ—è¡¨

**ä¿®å¤å‰ï¼š** âœ… æ‰€æœ‰æˆ¿é—´  
**ä¿®å¤åï¼š** âœ… æ‰€æœ‰æˆ¿é—´ï¼ˆå¦‚æœæ˜¯å…¬å¼€ï¼‰  
**ç»“è®ºï¼š** âœ… æ— å·®å¼‚ï¼ˆå¯¹å…¬å¼€æˆ¿é—´ï¼‰

```
ç”¨æˆ· C æŸ¥çœ‹æˆ¿é—´åˆ—è¡¨
â†’ å¯ä»¥çœ‹åˆ°æ‰€æœ‰ visibility='public' æˆ¿é—´
â†’ ä¸èƒ½çœ‹åˆ° visibility='private' æˆ¿é—´
```

---

## ğŸ“ˆ å®‰å…¨è¯„åˆ†

### ä¿®å¤å‰

```
æ•°æ®éšç§:     â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20%  ğŸš¨
è®¿é—®æ§åˆ¶:     â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20%  ğŸš¨
è§„åˆ™æ­£ç¡®æ€§:   â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 30%  âš ï¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»ä½“è¯„åˆ†:     25% - ä¸¥é‡é£é™©
```

### ä¿®å¤å

```
æ•°æ®éšç§:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 95%  âœ…
è®¿é—®æ§åˆ¶:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 95%  âœ…
è§„åˆ™æ­£ç¡®æ€§:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 95%  âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»ä½“è¯„åˆ†:     95% - ç”Ÿäº§çº§å®‰å…¨
```

---

## ğŸ’¾ è§„åˆ™æ–‡ä»¶å¤§å°

```
ä¿®å¤å‰: firebase.rules.json = 5.2 KB
ä¿®å¤å: firebase.rules.json = 5.8 KB (+0.6 KB)

é¢å¤–æˆæœ¬ï¼š
- è§„åˆ™æ£€æŸ¥å¤æ‚åº¦ï¼šä» O(1) â†’ O(2)ï¼ˆå¯æ¥å—ï¼‰
- Firebase é™é¢ï¼šæ— å½±å“ï¼ˆè§„åˆ™ä¸è®¡å…¥å®šä»·ï¼‰
```

---

## âœ”ï¸ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] é˜…è¯»æœ¬æ–‡ä»¶ç†è§£æ‰€æœ‰æ”¹åŠ¨
- [ ] éªŒè¯å½“å‰åŠŸèƒ½æ— è¯¯
- [ ] å¤‡ä»½ `firebase.rules.json`
- [ ] åº”ç”¨ `firebase.rules.json.fixed`
- [ ] è¿è¡Œ `firebase deploy --dry-run`
- [ ] ç¡®è®¤æ²¡æœ‰è¯­æ³•é”™è¯¯
- [ ] è¿è¡Œ `firebase deploy --only database`
- [ ] éªŒè¯éƒ¨ç½²æˆåŠŸ
- [ ] æµ‹è¯•å„ä¸ªåŠŸèƒ½
- [ ] æäº¤ä»£ç åˆ° Git
- [ ] åˆ›å»ºå‘å¸ƒæ ‡ç­¾

---

**ç»“è®ºï¼š** ä¿®å¤æ˜¯å®‰å…¨å¿…éœ€ä¸”åŠŸèƒ½æ— å®³çš„ã€‚å¼ºçƒˆæ¨èç«‹å³æ‰§è¡Œã€‚


